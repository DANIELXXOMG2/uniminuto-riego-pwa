# ๐๏ธ Arquitectura del Sistema de Riego v3.0

## ๐ Diagrama de Componentes

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        SISTEMA DE RIEGO AUTOMATIZADO v3.0                โ
โ                        ESP32/ESP8266 + Firebase Firestore                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          ESP32/ESP8266 FIRMWARE                             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                        SETUP (Inicializaciรณn)                      โ   โ
โ  โ                                                                     โ   โ
โ  โ  1. โ๏ธ  Configurar Hardware (pines GPIO, ADC)                     โ   โ
โ  โ  2. ๐ก Conectar a WiFi (WPA2, reintentos)                         โ   โ
โ  โ  3. ๐ Sincronizar con NTP (timestamps precisos)                  โ   โ
โ  โ  4. ๐ฅ Autenticar con Firebase (Email/Password)                   โ   โ
โ  โ  5. ๐ฅ Obtener configuraciรณn inicial (umbrales, intervalos)       โ   โ
โ  โ  6. ๐ฅ Obtener estados de lรญneas (isActive)                       โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                     LOOP (Ejecuciรณn Continua)                      โ   โ
โ  โ                                                                     โ   โ
โ  โ  Temporizador 1 (Continuo):                                       โ   โ
โ  โ    โโ ๐ Verificar conexiรณn WiFi โ Reconectar si necesario       โ   โ
โ  โ                                                                     โ   โ
โ  โ  Temporizador 2 (Cada 5 minutos):                                 โ   โ
โ  โ    โโ โ๏ธ  Sincronizar configuraciรณn desde Firestore              โ   โ
โ  โ                                                                     โ   โ
โ  โ  Temporizador 3 (Cada 30 segundos):                               โ   โ
โ  โ    โโ ๐ Sincronizar estados isActive desde Firestore            โ   โ
โ  โ                                                                     โ   โ
โ  โ  Temporizador 4 (Intervalo configurable - default 10 min):        โ   โ
โ  โ    โโ ๐ Leer 18 sensores de humedad                             โ   โ
โ  โ    โโ ๐ค Enviar lecturas a Firestore                             โ   โ
โ  โ    โโ ๐ง Controlar 3 vรกlvulas (umbral + isActive)                โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ๏ธ
                            HTTPS/TLS (Puerto 443)
                                        โ๏ธ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           FIREBASE FIRESTORE                                โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ  โ    Colecciรณn: config     โ  โ Colecciรณn: irrigationLinesโ              โ
โ  โ                          โ  โ                            โ              โ
โ  โ  ๐ device_config        โ  โ  ๐ line-001               โ              โ
โ  โ    โข thresholdLine1      โ  โ    โข name                  โ              โ
โ  โ    โข thresholdLine2      โ  โ    โข isActive โ          โ              โ
โ  โ    โข thresholdLine3      โ  โ    โข sensorIds[]           โ              โ
โ  โ    โข readingInterval     โ  โ                            โ              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ  ๐ line-002 / line-003    โ              โ
โ              โ                  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ               โ
โ              โ                              โ                               โ
โ         READ (5 min)                   READ (30 seg)                        โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ  โ              Colecciรณn: sensors                        โ                โ
โ  โ                                                         โ                โ
โ  โ  ๐ sensor-001/                                        โ                โ
โ  โ    โโ ๐ readings/                                     โ                โ
โ  โ         โโ ๐ auto-id-1 { timestamp, valueVWC }       โ                โ
โ  โ         โโ ๐ auto-id-2 { timestamp, valueVWC }       โ                โ
โ  โ         โโ ...                                         โ                โ
โ  โ                                                         โ                โ
โ  โ  ๐ sensor-002/ ... sensor-018/                        โ                โ
โ  โ    โโ (Same structure)                                 โ                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ                          โ                                                  โ
โ                     WRITE (Cada intervalo)                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                        โ๏ธ
                             Firebase Authentication
                             (Email/Password del dispositivo)
```

## ๐ Diagrama de Conexiones Hardware

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                           ESP32 DevKit V1                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

        GPIO 4 โโโโโโโโโ
        GPIO 5 โโโโโโโโโค
        GPIO 6 โโโโโโโโโผโโโโโโโโโโโโโโโบ Multiplexor 1 (S0-S3)
        GPIO 7 โโโโโโโโโ                   โ
                                          โ  16 canales
        GPIO 34 (ADC) โโโโโโโโโโโโโโโโโโโโโโ
                โ
                โโ Sensor 1 (VWC)
                โโ Sensor 2 (VWC)
                โโ ...
                โโ Sensor 16 (VWC)

        GPIO 4-7 (compartidos) โโโโโโโโโบ Multiplexor 2 (S0-S3)
                                              โ
        GPIO 35 (ADC) โโโโโโโโโโโโโโโโโโโโโโโโโ  2 canales
                โ
                โโ Sensor 17 (VWC)
                โโ Sensor 18 (VWC)

        GPIO 25 โโโโโโโโโโโบ Relay Mรณdulo 1 โโโโโโโบ Electrovรกlvula 1
        GPIO 26 โโโโโโโโโโโบ Relay Mรณdulo 2 โโโโโโโบ Electrovรกlvula 2
        GPIO 27 โโโโโโโโโโโบ Relay Mรณdulo 3 โโโโโโโบ Electrovรกlvula 3

        USB-C โโโโโโโโโโโโโบ Programaciรณn y Monitor Serial (115200 baud)
        
        3.3V/5V โโโโโโโโโโโบ Alimentaciรณn (sensores, multiplexores)
        GND โโโโโโโโโโโโโโโโบ Tierra comรบn
```

## ๐ Flujo de Datos Detallado

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          CICLO DE LECTURA                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    โฐ Cada [intervaloLectura] ms (default: 600,000 = 10 min)
         โ
         โโโบ 1. ๐ LEER SENSORES
         โ       โโ Multiplexor 1: Canales 0-15 โ Sensores 1-16
         โ       โ   โโ setChannel(n) โ delayMicroseconds(50) โ analogRead(SIG1)
         โ       โโ Multiplexor 2: Canales 0-1  โ Sensores 17-18
         โ       โ   โโ setChannel(n) โ delayMicroseconds(50) โ analogRead(SIG2)
         โ       โโ Convertir ADC a VWC: calcularVWC(lectura)
         โ       โโ Calcular promedios por lรญnea: (s1+s2+...+s6)/6
         โ
         โโโบ 2. ๐ค ENVIAR A FIRESTORE
         โ       โโ Verificar WiFi conectado โ
         โ       โโ Verificar Firebase autenticado โ
         โ       โโ Para cada sensor (1-18):
         โ           โโ Crear FirebaseJson con timestamp + valueVWC
         โ           โโ Firebase.Firestore.createDocument(
         โ               sensors/sensor-XXX/readings/{auto-id})
         โ
         โโโบ 3. ๐ง CONTROLAR VรLVULAS
                 โโ Lรญnea 1: if (promedio[0] < umbral1 && isActiveLine1) โ HIGH
                 โโ Lรญnea 2: if (promedio[1] < umbral2 && isActiveLine2) โ HIGH
                 โโ Lรญnea 3: if (promedio[2] < umbral3 && isActiveLine3) โ HIGH

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    SINCRONIZACIรN BIDIRECCIONAL                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    ๐ฅ DESDE FIRESTORE (Lectura)
         โ
         โโโบ Cada 5 minutos:
         โ       โโ GET /config/device_config
         โ           โโ thresholdLine1 โ umbral_linea1
         โ           โโ thresholdLine2 โ umbral_linea2
         โ           โโ thresholdLine3 โ umbral_linea3
         โ           โโ readingInterval โ intervaloLectura
         โ
         โโโบ Cada 30 segundos:
                 โโ GET /irrigationLines/{line-001,002,003}
                     โโ line-001.isActive โ isActiveLine1
                     โโ line-002.isActive โ isActiveLine2
                     โโ line-003.isActive โ isActiveLine3

    ๐ค HACIA FIRESTORE (Escritura)
         โ
         โโโบ Cada [intervaloLectura]:
                 โโ CREATE /sensors/{sensorId}/readings/{auto-id}
                     โโ timestamp: [ISO8601 de NTP]
                     โโ valueVWC: [0.0 - 100.0]
```

## ๐ Capa de Seguridad

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         AUTENTICACIรN Y SEGURIDAD                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    ESP32/ESP8266
         โ
         โโโบ 1. ๐ AUTENTICACIรN
         โ       โโ Email: dispositivo@tudominio.com
         โ       โโ Password: [contraseรฑa segura]
         โ       โโ Firebase.begin(&config, &auth)
         โ           โโ Obtiene ID Token (JWT)
         โ               โโ Vรกlido por 1 hora
         โ               โโ Auto-renovaciรณn por librerรญa
         โ
         โโโบ 2. ๐ HTTPS/TLS
         โ       โโ Puerto 443
         โ       โโ Certificados SSL/TLS automรกticos
         โ       โโ Encriptaciรณn end-to-end
         โ
         โโโบ 3. ๐ก๏ธ REGLAS FIRESTORE
                 โโ config/* : read (auth) / write (admin only)
                 โโ irrigationLines/* : read (auth) / write (admin/operator)
                 โโ sensors/*/readings/* : create (dispositivo only)
```

## โฑ๏ธ Timeline de Eventos

```
T = 0 seg     โโโบ POWER ON
              โโโบ Inicializar Serial (115200 baud)
              โโโบ Configurar GPIO
              โโโบ Vรกlvulas OFF

T = 0-5 seg   โโโบ Conectar WiFi (reintentos cada 500ms)
              โโโบ Obtener IP por DHCP

T = 5-10 seg  โโโบ Sincronizar con NTP
              โโโบ Ajustar reloj interno

T = 10-15 seg โโโบ Autenticar con Firebase
              โโโบ Obtener ID Token

T = 15-20 seg โโโบ GET config inicial
              โโโบ GET estados isActive
              โโโบ Sistema listo โ

T = 20 seg+   โโโบ LOOP CONTINUO
              โ
              โโโบ Cada 1ms:    Verificar WiFi
              โโโบ Cada 5min:   Sync config
              โโโบ Cada 30seg:  Sync isActive
              โโโบ Cada 10min:  Leer + Enviar + Controlar
```

## ๐๏ธ Estados del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        MรQUINA DE ESTADOS                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

         [INICIO]
            โ
            โผ
    โโโโโโโโโโโโโโโโโ
    โ INITIALIZATION โ
    โ   (setup)     โ
    โโโโโโโโโฌโโโโโโโโ
            โ
            โผ
    โโโโโโโโโโโโโโโโโ     โ Error
    โ  CONNECTING   โโโโโโโโโโโโบ [RETRY] (cada 30s)
    โ   (WiFi)      โ
    โโโโโโโโโฌโโโโโโโโ
            โ โ Conectado
            โผ
    โโโโโโโโโโโโโโโโโ     โ Error
    โ AUTHENTICATINGโโโโโโโโโโโโบ [RETRY] (cada 30s)
    โ   (Firebase)  โ
    โโโโโโโโโฌโโโโโโโโ
            โ โ Autenticado
            โผ
    โโโโโโโโโโโโโโโโโ
    โ   FETCHING    โ
    โ    CONFIG     โ
    โโโโโโโโโฌโโโโโโโโ
            โ
            โผ
    โโโโโโโโโโโโโโโโโ
    โ   RUNNING     โโโโโโโโ
    โ   (loop)      โ      โ
    โ               โ      โ
    โ โโ Monitor    โ      โ
    โ โโ Sync       โ      โ
    โ โโ Read       โ      โ
    โ โโ Send       โ      โ
    โ โโ Control    โ      โ
    โโโโโโโโโฌโโโโโโโโ      โ
            โ              โ
            โโโโโโโโโโโโโโโโ
              Continuo
```

## ๐ Optimizaciรณn de Recursos

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      USO DE RECURSOS ESP32                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    RAM (SRAM):
        โโ Stack:          ~8 KB
        โโ Heap:           ~20 KB
        โโ Firebase:       ~50 KB
        โโ WiFi:           ~40 KB
        โโ Disponible:     ~200 KB (de ~320 KB total)

    Flash:
        โโ Firmware:       ~500 KB
        โโ Librerรญas:      ~300 KB
        โโ Filesystem:     ~100 KB
        โโ Disponible:     ~3.1 MB (de ~4 MB total)

    CPU:
        โโ Loop:           < 1% (idle la mayor parte)
        โโ WiFi:           ~5-10% (durante transmisiรณn)
        โโ Firebase:       ~10-20% (durante operaciones)
        โโ Sensores:       < 1% (lectura muy rรกpida)

    Energรญa:
        โโ WiFi activo:    ~160 mA @ 3.3V
        โโ Transmisiรณn:    ~200 mA picos
        โโ Idle:           ~80 mA
        โโ Deep Sleep*:    ~10 ฮผA (*no implementado)
```

---

**Notas:**
- Todos los diagramas son representaciones simplificadas
- Los tiempos son aproximados y pueden variar segรบn red y hardware
- La implementaciรณn de deep sleep reducirรญa el consumo a < 1 mA promedio

