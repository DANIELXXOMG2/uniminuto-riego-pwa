# ğŸ—ï¸ Arquitectura del Sistema de Riego v3.0

## ğŸ“ Diagrama de Componentes

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        SISTEMA DE RIEGO AUTOMATIZADO v3.0                â•‘
â•‘                        ESP32/ESP8266 + Firebase Firestore                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ESP32/ESP8266 FIRMWARE                             â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        SETUP (InicializaciÃ³n)                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  1. âš™ï¸  Configurar Hardware (pines GPIO, ADC)                     â”‚   â”‚
â”‚  â”‚  2. ğŸ“¡ Conectar a WiFi (WPA2, reintentos)                         â”‚   â”‚
â”‚  â”‚  3. ğŸ• Sincronizar con NTP (timestamps precisos)                  â”‚   â”‚
â”‚  â”‚  4. ğŸ”¥ Autenticar con Firebase (Email/Password)                   â”‚   â”‚
â”‚  â”‚  5. ğŸ“¥ Obtener configuraciÃ³n inicial (umbrales, intervalos)       â”‚   â”‚
â”‚  â”‚  6. ğŸ“¥ Obtener estados de lÃ­neas (isActive)                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     LOOP (EjecuciÃ³n Continua)                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Temporizador 1 (Continuo):                                       â”‚   â”‚
â”‚  â”‚    â””â”€ ğŸ”„ Verificar conexiÃ³n WiFi â†’ Reconectar si necesario       â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Temporizador 2 (Cada 5 minutos):                                 â”‚   â”‚
â”‚  â”‚    â””â”€ âš™ï¸  Sincronizar configuraciÃ³n desde Firestore              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Temporizador 3 (Cada 30 segundos):                               â”‚   â”‚
â”‚  â”‚    â””â”€ ğŸ”„ Sincronizar estados isActive desde Firestore            â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Temporizador 4 (Intervalo configurable - default 10 min):        â”‚   â”‚
â”‚  â”‚    â”œâ”€ ğŸ“Š Leer 18 sensores de humedad                             â”‚   â”‚
â”‚  â”‚    â”œâ”€ ğŸ“¤ Enviar lecturas a Firestore                             â”‚   â”‚
â”‚  â”‚    â””â”€ ğŸ’§ Controlar 3 vÃ¡lvulas (umbral + isActive)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â†•ï¸
                            HTTPS/TLS (Puerto 443)
                                        â†•ï¸
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FIREBASE FIRESTORE                                â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚    ColecciÃ³n: config     â”‚  â”‚ ColecciÃ³n: irrigationLinesâ”‚              â”‚
â”‚  â”‚                          â”‚  â”‚                            â”‚              â”‚
â”‚  â”‚  ğŸ“„ device_config        â”‚  â”‚  ğŸ“„ line-001               â”‚              â”‚
â”‚  â”‚    â€¢ thresholdLine1      â”‚  â”‚    â€¢ name                  â”‚              â”‚
â”‚  â”‚    â€¢ thresholdLine2      â”‚  â”‚    â€¢ isActive âœ…          â”‚              â”‚
â”‚  â”‚    â€¢ thresholdLine3      â”‚  â”‚    â€¢ sensorIds[]           â”‚              â”‚
â”‚  â”‚    â€¢ readingInterval     â”‚  â”‚                            â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  ğŸ“„ line-002 / line-003    â”‚              â”‚
â”‚              â†‘                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                              â†‘                               â”‚
â”‚         READ (5 min)                   READ (30 seg)                        â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚              ColecciÃ³n: sensors                        â”‚                â”‚
â”‚  â”‚                                                         â”‚                â”‚
â”‚  â”‚  ğŸ“ sensor-001/                                        â”‚                â”‚
â”‚  â”‚    â””â”€ ğŸ“ readings/                                     â”‚                â”‚
â”‚  â”‚         â”œâ”€ ğŸ“„ auto-id-1 { timestamp, valueVWC }       â”‚                â”‚
â”‚  â”‚         â”œâ”€ ğŸ“„ auto-id-2 { timestamp, valueVWC }       â”‚                â”‚
â”‚  â”‚         â””â”€ ...                                         â”‚                â”‚
â”‚  â”‚                                                         â”‚                â”‚
â”‚  â”‚  ğŸ“ sensor-002/ ... sensor-018/                        â”‚                â”‚
â”‚  â”‚    â””â”€ (Same structure)                                 â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                          â†‘                                                  â”‚
â”‚                     WRITE (Cada intervalo)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â†•ï¸
                             Firebase Authentication
                             (Email/Password del dispositivo)
```

## ğŸ”Œ Diagrama de Conexiones Hardware

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           ESP32 DevKit V1                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        GPIO 4 â”€â”€â”€â”€â”€â”€â”€â”€â”
        GPIO 5 â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        GPIO 6 â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Multiplexor 1 (S0-S3)
        GPIO 7 â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
                                          â”‚  16 canales
        GPIO 34 (ADC) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â””â”€ Sensor 1 (VWC)
                â””â”€ Sensor 2 (VWC)
                â””â”€ ...
                â””â”€ Sensor 16 (VWC)

        GPIO 4-7 (compartidos) â”€â”€â”€â”€â”€â”€â”€â”€â–º Multiplexor 2 (S0-S3)
                                              â”‚
        GPIO 35 (ADC) â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  2 canales
                â”‚
                â””â”€ Sensor 17 (VWC)
                â””â”€ Sensor 18 (VWC)

        GPIO 25 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Relay MÃ³dulo 1 â”€â”€â”€â”€â”€â”€â–º ElectrovÃ¡lvula 1
        GPIO 26 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Relay MÃ³dulo 2 â”€â”€â”€â”€â”€â”€â–º ElectrovÃ¡lvula 2
        GPIO 27 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Relay MÃ³dulo 3 â”€â”€â”€â”€â”€â”€â–º ElectrovÃ¡lvula 3

        USB-C â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ProgramaciÃ³n y Monitor Serial (115200 baud)
        
        3.3V/5V â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º AlimentaciÃ³n (sensores, multiplexores)
        GND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Tierra comÃºn
```

## ğŸ“Š Flujo de Datos Detallado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CICLO DE LECTURA                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â° Cada [intervaloLectura] ms (default: 600,000 = 10 min)
         â”‚
         â”œâ”€â–º 1. ğŸ“Š LEER SENSORES
         â”‚       â”œâ”€ Multiplexor 1: Canales 0-15 â†’ Sensores 1-16
         â”‚       â”‚   â””â”€ setChannel(n) â†’ delayMicroseconds(50) â†’ analogRead(SIG1)
         â”‚       â”œâ”€ Multiplexor 2: Canales 0-1  â†’ Sensores 17-18
         â”‚       â”‚   â””â”€ setChannel(n) â†’ delayMicroseconds(50) â†’ analogRead(SIG2)
         â”‚       â”œâ”€ Convertir ADC a VWC: calcularVWC(lectura)
         â”‚       â””â”€ Calcular promedios por lÃ­nea: (s1+s2+...+s6)/6
         â”‚
         â”œâ”€â–º 2. ğŸ“¤ ENVIAR A FIRESTORE
         â”‚       â”œâ”€ Verificar WiFi conectado âœ…
         â”‚       â”œâ”€ Verificar Firebase autenticado âœ…
         â”‚       â””â”€ Para cada sensor (1-18):
         â”‚           â”œâ”€ Crear FirebaseJson con timestamp + valueVWC
         â”‚           â””â”€ Firebase.Firestore.createDocument(
         â”‚               sensors/sensor-XXX/readings/{auto-id})
         â”‚
         â””â”€â–º 3. ğŸ’§ CONTROLAR VÃLVULAS
                 â”œâ”€ LÃ­nea 1: if (promedio[0] < umbral1 && isActiveLine1) â†’ HIGH
                 â”œâ”€ LÃ­nea 2: if (promedio[1] < umbral2 && isActiveLine2) â†’ HIGH
                 â””â”€ LÃ­nea 3: if (promedio[2] < umbral3 && isActiveLine3) â†’ HIGH

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SINCRONIZACIÃ“N BIDIRECCIONAL                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ğŸ“¥ DESDE FIRESTORE (Lectura)
         â”‚
         â”œâ”€â–º Cada 5 minutos:
         â”‚       â””â”€ GET /config/device_config
         â”‚           â”œâ”€ thresholdLine1 â†’ umbral_linea1
         â”‚           â”œâ”€ thresholdLine2 â†’ umbral_linea2
         â”‚           â”œâ”€ thresholdLine3 â†’ umbral_linea3
         â”‚           â””â”€ readingInterval â†’ intervaloLectura
         â”‚
         â””â”€â–º Cada 30 segundos:
                 â””â”€ GET /irrigationLines/{line-001,002,003}
                     â”œâ”€ line-001.isActive â†’ isActiveLine1
                     â”œâ”€ line-002.isActive â†’ isActiveLine2
                     â””â”€ line-003.isActive â†’ isActiveLine3

    ğŸ“¤ HACIA FIRESTORE (Escritura)
         â”‚
         â””â”€â–º Cada [intervaloLectura]:
                 â””â”€ CREATE /sensors/{sensorId}/readings/{auto-id}
                     â”œâ”€ timestamp: [ISO8601 de NTP]
                     â””â”€ valueVWC: [0.0 - 100.0]
```

## ğŸ” Capa de Seguridad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AUTENTICACIÃ“N Y SEGURIDAD                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    ESP32/ESP8266
         â”‚
         â”œâ”€â–º 1. ğŸ”‘ AUTENTICACIÃ“N
         â”‚       â”œâ”€ Email: dispositivo@tudominio.com
         â”‚       â”œâ”€ Password: [contraseÃ±a segura]
         â”‚       â””â”€ Firebase.begin(&config, &auth)
         â”‚           â””â”€ Obtiene ID Token (JWT)
         â”‚               â”œâ”€ VÃ¡lido por 1 hora
         â”‚               â””â”€ Auto-renovaciÃ³n por librerÃ­a
         â”‚
         â”œâ”€â–º 2. ğŸ”’ HTTPS/TLS
         â”‚       â”œâ”€ Puerto 443
         â”‚       â”œâ”€ Certificados SSL/TLS automÃ¡ticos
         â”‚       â””â”€ EncriptaciÃ³n end-to-end
         â”‚
         â””â”€â–º 3. ğŸ›¡ï¸ REGLAS FIRESTORE
                 â”œâ”€ config/* : read (auth) / write (admin only)
                 â”œâ”€ irrigationLines/* : read (auth) / write (admin/operator)
                 â””â”€ sensors/*/readings/* : create (dispositivo only)
```

## â±ï¸ Timeline de Eventos

```
T = 0 seg     â”Œâ”€â–º POWER ON
              â”œâ”€â–º Inicializar Serial (115200 baud)
              â”œâ”€â–º Configurar GPIO
              â””â”€â–º VÃ¡lvulas OFF

T = 0-5 seg   â”Œâ”€â–º Conectar WiFi (reintentos cada 500ms)
              â””â”€â–º Obtener IP por DHCP

T = 5-10 seg  â”Œâ”€â–º Sincronizar con NTP
              â””â”€â–º Ajustar reloj interno

T = 10-15 seg â”Œâ”€â–º Autenticar con Firebase
              â””â”€â–º Obtener ID Token

T = 15-20 seg â”Œâ”€â–º GET config inicial
              â”œâ”€â–º GET estados isActive
              â””â”€â–º Sistema listo âœ…

T = 20 seg+   â”Œâ”€â–º LOOP CONTINUO
              â”‚
              â”œâ”€â–º Cada 1ms:    Verificar WiFi
              â”œâ”€â–º Cada 5min:   Sync config
              â”œâ”€â–º Cada 30seg:  Sync isActive
              â””â”€â–º Cada 10min:  Leer + Enviar + Controlar
```

## ğŸ›ï¸ Estados del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        MÃQUINA DE ESTADOS                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         [INICIO]
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ INITIALIZATION â”‚
    â”‚   (setup)     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     âŒ Error
    â”‚  CONNECTING   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [RETRY] (cada 30s)
    â”‚   (WiFi)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ âœ… Conectado
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     âŒ Error
    â”‚ AUTHENTICATINGâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º [RETRY] (cada 30s)
    â”‚   (Firebase)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ âœ… Autenticado
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   FETCHING    â”‚
    â”‚    CONFIG     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   RUNNING     â”‚â—„â”€â”€â”€â”€â”€â”
    â”‚   (loop)      â”‚      â”‚
    â”‚               â”‚      â”‚
    â”‚ â”œâ”€ Monitor    â”‚      â”‚
    â”‚ â”œâ”€ Sync       â”‚      â”‚
    â”‚ â”œâ”€ Read       â”‚      â”‚
    â”‚ â”œâ”€ Send       â”‚      â”‚
    â”‚ â””â”€ Control    â”‚      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
            â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              Continuo
```

## ğŸ“ˆ OptimizaciÃ³n de Recursos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USO DE RECURSOS ESP32                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    RAM (SRAM):
        â”œâ”€ Stack:          ~8 KB
        â”œâ”€ Heap:           ~20 KB
        â”œâ”€ Firebase:       ~50 KB
        â”œâ”€ WiFi:           ~40 KB
        â””â”€ Disponible:     ~200 KB (de ~320 KB total)

    Flash:
        â”œâ”€ Firmware:       ~500 KB
        â”œâ”€ LibrerÃ­as:      ~300 KB
        â”œâ”€ Filesystem:     ~100 KB
        â””â”€ Disponible:     ~3.1 MB (de ~4 MB total)

    CPU:
        â”œâ”€ Loop:           < 1% (idle la mayor parte)
        â”œâ”€ WiFi:           ~5-10% (durante transmisiÃ³n)
        â”œâ”€ Firebase:       ~10-20% (durante operaciones)
        â””â”€ Sensores:       < 1% (lectura muy rÃ¡pida)

    EnergÃ­a:
        â”œâ”€ WiFi activo:    ~160 mA @ 3.3V
        â”œâ”€ TransmisiÃ³n:    ~200 mA picos
        â”œâ”€ Idle:           ~80 mA
        â””â”€ Deep Sleep*:    ~10 Î¼A (*no implementado)
```

---

**Notas:**
- Todos los diagramas son representaciones simplificadas
- Los tiempos son aproximados y pueden variar segÃºn red y hardware
- La implementaciÃ³n de deep sleep reducirÃ­a el consumo a < 1 mA promedio

