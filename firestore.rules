rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- FUNCIONES HELPER ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper seguro: Verifica si existe el doc antes de pedir .data
    // Esto evita el crash cuando un usuario nuevo se est√° registrando
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isUserDocExisting() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function isAdmin() {
      return isAuthenticated() && 
             isUserDocExisting() && 
             getUserData().role == 'admin';
    }
    
    function isAdminOrSupervisor() {
      return isAuthenticated() && 
             isUserDocExisting() && 
             getUserData().role in ['admin', 'supervisor'];
    }
    
    // --- REGLAS POR COLECCI√ìN ---

    // 1. USUARIOS üë§
    match /users/{userId} {
      // Permitir que el usuario cree/lea/escriba su propio documento
      // O que un admin (si existe su doc) pueda leer/escribir cualquier usuario
      allow read, write: if isAuthenticated() && 
                            (request.auth.uid == userId || 
                            (isUserDocExisting() && isAdmin()));
    }
    
    // 2. L√çNEAS DE RIEGO üíß
    match /irrigationLines/{lineId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSupervisor();
    }
    
    // 3. SENSORES Y LECTURAS üå°Ô∏è
    match /sensors/{sensorId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSupervisor();
      
      match /readings/{readingId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrSupervisor();
      }
      
      match /readingsHourly/{hourId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrSupervisor();
      }
    }
    
    // 4. CONFIGURACI√ìN DEL SISTEMA ‚öôÔ∏è
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // 5. NOTIFICACIONES üîî
    match /notifications/{notificationId} {
      // Solo el due√±o de la notificaci√≥n o un admin pueden leerla
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isAdmin());
      // Solo el sistema (v√≠a Admin SDK) o admins pueden crear/borrar
      allow write: if isAdmin();
    }
    
    // 6. LOGS üìù
    match /logs/{logId} {
      allow read, write: if isAdmin();
    }
  }
}
