rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Función helper para verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Función helper para verificar si el usuario es admin
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Función helper para verificar si el usuario es admin o supervisor
    function isAdminOrSupervisor() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'supervisor'];
    }
    
    // Colección de usuarios - Solo admins pueden ver todos, usuarios pueden ver/editar su propio perfil
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Líneas de riego - Admins y supervisores pueden leer/escribir
    match /irrigationLines/{lineId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSupervisor();
    }
    
    // Sensores y sus lecturas - Todos los autenticados pueden leer, solo admins/supervisors escriben
    match /sensors/{sensorId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrSupervisor();
      
      // Lecturas de sensores (raw)
      match /readings/{readingId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrSupervisor();
      }
      
      // Lecturas agregadas por hora
      match /readingsHourly/{hourId} {
        allow read: if isAuthenticated();
        allow write: if isAdminOrSupervisor();
      }
    }
    
    // Configuración del sistema - Todos pueden leer, solo admins pueden escribir
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Notificaciones - Usuarios pueden leer sus propias notificaciones
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Logs del sistema - Solo admins
    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
